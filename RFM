SELECT
TRIM(ORG.CO_NBR) AS "company_no",
CUST.CUST_NBR AS "cust_no",
CUST.CUST_NM as "cust_nm",
CURRENT_DATE-CUST.FIRST_INVC_DT as "tenure",
CUST.LST_INVC_DT as "last purchase date",
sum(SALES.PRC_EXT_AMT) as "Sales",
sum(SALES.PRC_EXT_AMT)-sum(SALES.TAX_CST_ACOGS_EXT_AMT) as "gp",
sum(CASE_SOLD_QTY) as "quantity",
COUNT(DISTINCT WK.FISC_WK_ID||TRIM(ORG.CO_NBR)||CUST.CUST_NBR) as "frequency"
FROM
EDWP..SALE_OBLIG_DTL_FACT SALES INNER JOIN EDWP..CUST_SHIP_TO_DIM CUST ON (SALES.CUST_SKEY=CUST.CUST_SKEY
AND SALES.OBLIG_DT BETWEEN CUST.CUST_SHIP_TO_REC_EFF_DT AND CUST_SHIP_TO_REC_TRM_DT)
INNER JOIN EDWP..ORG_CO_DIM ORG ON (ORG.CO_SKEY=CUST.CO_SKEY)
INNER JOIN EDWP..ITM_DIM ITM ON (SALES.ITM_SKEY=ITM.ITM_SKEY
AND SALES.OBLIG_DT BETWEEN ITM_REC_EFF_DT AND ITM_REC_TRM_DT)
INNER JOIN EDWP..CAL_FISC_WK_DIM WK ON (SALES.OBLIG_DT BETWEEN FISC_WK_STRT_DT AND FISC_WK_END_DT)
WHERE
CUST.ACCT_TYP_CD IN ('TRS','TRP')
AND SALES.TRD_SALE_IND='T'
AND SALES.PRC_EXT_AMT>0.01
AND SALES.PCS_SOLD_QTY>0
AND TRIM(ORG.CO_NBR)='058'
AND FISC_WK_ID BETWEEN 201401 AND 201452
AND SALES.TRANS_CD='I'
GROUP BY
TRIM(ORG.CO_NBR),
CUST.CUST_NBR,
CURRENT_DATE-CUST.FIRST_INVC_DT,
CUST.CUST_NM,
CUST.LST_INVC_DT